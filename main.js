/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
If you want to view the source, please visit the github repository of this plugin
*/

var _=Object.defineProperty;var k=Object.getOwnPropertyDescriptor;var y=Object.getOwnPropertyNames;var F=Object.prototype.hasOwnProperty;var H=(l,t)=>{for(var e in t)_(l,e,{get:t[e],enumerable:!0})},W=(l,t,e,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of y(t))!F.call(l,a)&&a!==e&&_(l,a,{get:()=>t[a],enumerable:!(i=k(t,a))||i.enumerable});return l};var G=l=>W(_({},"__esModule",{value:!0}),l);var b={};H(b,{default:()=>N});module.exports=G(b);var P=require("obsidian");var u=require("obsidian"),I={defaultSortMode:"name",defaultFilterMode:1,excludedTags:"",defaultGroupState:"expanded",showMatchedTags:!1},w=class extends u.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;t.empty(),new u.Setting(t).setName("Default sort mode").setDesc("Default sort method for related notes").addDropdown(i=>i.addOption("name","Name").addOption("date","Date Edited").addOption("created","Date Created").setValue(this.plugin.settings.defaultSortMode).onChange(async a=>{this.plugin.settings.defaultSortMode=a,await this.plugin.saveSettings()})),new u.Setting(t).setName("Excluded tags").setDesc("Comma-separated list of tags to exclude from related notes (# prefix optional)").addText(i=>i.setPlaceholder("e.g., ignore, draft, #private").setValue(this.plugin.settings.excludedTags).onChange(async a=>{this.plugin.settings.excludedTags=a,await this.plugin.saveSettings()})),new u.Setting(t).setName("Default group state").setDesc("Initial expansion state of tag groups").addDropdown(i=>i.addOption("collapsed","Collapsed").addOption("expanded","Expanded").setValue(this.plugin.settings.defaultGroupState).onChange(async a=>{this.plugin.settings.defaultGroupState=a,await this.plugin.saveSettings()})),t.createEl("h3",{text:"Activation and usage instructions"});let e=t.createDiv("related-notes-instructions");e.createEl("p",{text:"To activate the Related Notes by Tag sidebar:"}),e.createEl("ul",{},i=>{i.createEl("li",{text:"Click the ribbon icon (tag icon) in the top right if visible"}),i.createEl("li",{text:'Or use the command palette: "Related Notes by Tag: Open sidebar"'})}),e.createEl("p",{text:"Usage:"}),e.createEl("ul",{},i=>{i.createEl("li",{text:"Click tag group header to expand/collapse group"}),i.createEl("li",{text:"Click note name to open in current tab"}),i.createEl("li",{text:"Cmd/ctrl-click note name to open note in a new tab"}),i.createEl("li",{text:"Click Name/Date to change sort order"})})}};var A=require("obsidian");var C=require("obsidian"),m=class{constructor(t){this.app=t}analyzeRelatedNotes(t,e){let i=this.app.metadataCache.getFileCache(t);if(!i)return{relatedNotesMap:new Map,currentNoteTags:[]};let a=(0,C.getAllTags)(i);if(!a||a.length===0)return{relatedNotesMap:new Map,currentNoteTags:[]};let n=this.getFilteredTags(a,e.excludedTags);return{relatedNotesMap:this.findRelatedNotes(t,n,e.defaultFilterMode),currentNoteTags:n}}getFilteredTags(t,e){let i=e.split(",").map(a=>{let n=a.trim().toLowerCase();return n.startsWith("#")?n:`#${n}`}).filter(a=>a.length>1);return[...new Set(t)].filter(a=>!i.includes(a.toLowerCase()))}findRelatedNotes(t,e,i){let a=new Map,n=this.app.vault.getMarkdownFiles();for(let o of n){if(o.path===t.path)continue;let r=this.getOverlappingTags(o,e);if(r.length>=i){let h={file:o,matchedTags:r};r.forEach(p=>{var T;a.has(p)||a.set(p,[]),(T=a.get(p))==null||T.push(h)})}}return a}getOverlappingTags(t,e){let i=this.app.metadataCache.getFileCache(t);if(!i)return[];let a=(0,C.getAllTags)(i);if(!a)return[];let n=[...new Set(a)];return e.filter(o=>n.includes(o))}sortFiles(t,e){let i=[...t];switch(e){case"date":return i.sort((a,n)=>n.file.stat.mtime-a.file.stat.mtime);case"created":return i.sort((a,n)=>n.file.stat.ctime-a.file.stat.ctime);default:return i.sort((a,n)=>a.file.basename.localeCompare(n.file.basename))}}};var E=require("obsidian");var f={SORT:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="m3 8 4-4 4 4"/><path d="M7 4v16"/><path d="M11 12h4"/><path d="M11 16h7"/><path d="M11 20h10"/></svg>',FILTER:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M22 3H2l8 9.46V19l4 2v-8.54L22 3z"/></svg>',TAGS_TOGGLE:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M9 5H2v7l6.29 6.29c.94.94 2.48.94 3.42 0l3.58-3.58c.94-.94.94-2.48 0-3.42L9 5Z"/><path d="M6 9.01V9"/><path d="m15 5 6.3 6.3a2.69 2.69 0 0 1 0 3.79L17.5 19a2.69 2.69 0 0 1-3.79 0L10 15.21"/></svg>',DROPDOWN_CARET:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="m6 9 6 6 6-6"/></svg>',RELATED_NOTES:'<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-tags"><path d="M9 5H2v7l6.29 6.29c.94.94 2.48.94 3.42 0l3.58-3.58c.94-.94.94-2.48 0-3.42L9 5Z"/><path d="M6 9.01V9"/><path d="m15 5 6.3 6.3a2.69 2.69 0 0 1 0 3.79L17.5 19a2.69 2.69 0 0 1-3.79 0L10 15.21"/></svg>'},s={CONTAINER:"related-notes-container",HEADER:"related-notes-header",ACTION_BUTTONS:"action-buttons",SORT_CONTROLS:"sort-controls",FILTER_CONTROLS:"filter-controls",TAGS_TOGGLE_CONTROLS:"tags-toggle-controls",DROPDOWN_CONTAINER:"dropdown-container",DROPDOWN_TRIGGER:"dropdown-trigger",DROPDOWN_MENU:"dropdown-menu",DROPDOWN_ITEM:"dropdown-item",DROPDOWN_ITEM_ACTIVE:"is-active",DROPDOWN_VISIBLE:"is-visible",TAG_GROUP:"related-notes-tag-group",TAG_GROUP_HEADER:"related-notes-tag-group-header",NOTES_LIST:"related-notes-list",LIST_ITEM:"related-notes-list-item",NOTE_LINK:"related-note-link",MATCHED_TAGS:"matched-tags",MATCHED_TAG:"matched-tag",SEPARATOR:"related-notes-separator",PREVIEW:"related-notes-preview",PREVIEW_LOADED:"is-loaded",INSTRUCTIONS:"related-notes-instructions"},D={VIEW_UPDATE_DELAY:50,PREVIEW_RENDER_DELAY:150},v={PREVIEW_POPUP_WIDTH:400,PREVIEW_POPUP_MARGIN:10,PREVIEW_MAX_HEIGHT:"40vh"},d={NAME:"name",DATE:"date",CREATED:"created"},c={ONE_TAG:1,TWO_TAGS:2,THREE_TAGS:3};var M={[d.NAME]:"Name",[d.DATE]:"Modified Date",[d.CREATED]:"Created Date"},O={[c.ONE_TAG]:"Match at least 1 tag",[c.TWO_TAGS]:"Match at least 2 tags",[c.THREE_TAGS]:"Match at least 3 tags"};var S=class extends E.Component{constructor(e){super();this.app=e;this.previewPopup=null;this.currentPreviewFile=null;this.isModifierHeld=!1;this.lastMousePosition={x:0,y:0};this.trackMousePosition=e=>{this.lastMousePosition={x:e.clientX,y:e.clientY}};this.handleKeyDown=e=>{if(this.isModifierHeld=e.metaKey||e.ctrlKey,this.isModifierHeld){let i=document.elementFromPoint(this.lastMousePosition.x,this.lastMousePosition.y),a=i==null?void 0:i.closest(`.${s.NOTE_LINK}`);if(a instanceof HTMLElement&&a.dataset.filePath){let n=this.app.vault.getAbstractFileByPath(a.dataset.filePath);n instanceof E.TFile&&this.showPreview(n,a)}}};this.handleKeyUp=e=>{(e.key==="Meta"||e.key==="Control")&&(this.isModifierHeld=!1,this.previewPopup&&this.hidePreview())};this.hidePreviewOnClick=()=>{this.hidePreview()};this.setupEventListeners()}setupEventListeners(){document.addEventListener("mousemove",this.trackMousePosition),document.addEventListener("keydown",this.handleKeyDown),document.addEventListener("keyup",this.handleKeyUp)}cleanup(){document.removeEventListener("mousemove",this.trackMousePosition),document.removeEventListener("keydown",this.handleKeyDown),document.removeEventListener("keyup",this.handleKeyUp),this.hidePreview(),this.unload()}showPreview(e,i){this.hidePreview(),this.previewPopup=document.body.createDiv(s.PREVIEW),this.currentPreviewFile=e;let a=this.calculatePosition(i);this.applyPopupStyles(a),document.addEventListener("click",this.hidePreviewOnClick,{once:!0}),this.renderPreviewContent(e)}calculatePosition(e){let i=e.getBoundingClientRect(),a=window.innerWidth,n=v.PREVIEW_POPUP_WIDTH,o=v.PREVIEW_POPUP_MARGIN,r;return i.right+n+o<=a?r=i.right+o:i.left-n-o>=0?r=i.left-n-o:r=Math.max(o,Math.min((a-n)/2,a-n-o)),{left:r,top:i.top}}applyPopupStyles(e){this.previewPopup&&Object.assign(this.previewPopup.style,{position:"fixed",left:`${e.left}px`,top:`${e.top}px`,zIndex:"9999",width:`${v.PREVIEW_POPUP_WIDTH}px`,maxHeight:v.PREVIEW_MAX_HEIGHT,overflowY:"auto"})}renderPreviewContent(e){setTimeout(async()=>{var i;if(this.previewPopup&&this.currentPreviewFile===e&&this.isModifierHeld)try{let a=await this.app.vault.read(e);await E.MarkdownRenderer.render(this.app,a,this.previewPopup,e.path,this),(i=this.previewPopup)==null||i.addClass(s.PREVIEW_LOADED)}catch(a){console.error("Failed to render preview:",a),this.previewPopup&&this.previewPopup.setText("Failed to load preview")}},D.PREVIEW_RENDER_DELAY)}hidePreview(){this.previewPopup&&(this.previewPopup.remove(),this.previewPopup=null,this.currentPreviewFile=null)}getIsModifierHeld(){return this.isModifierHeld}};var R=class{constructor(){this.openDropdowns=new Set;this.handleGlobalClick=t=>{let e=t.target,i=!1;for(let a of this.openDropdowns)if(a.contains(e)){i=!0;break}i||this.closeAllDropdowns()};document.addEventListener("click",this.handleGlobalClick)}closeAllDropdowns(){this.openDropdowns.forEach(t=>{let e=t.querySelector(`.${s.DROPDOWN_MENU}`);e&&e.classList.remove(s.DROPDOWN_VISIBLE)})}createDropdown(t,e){let i=t.createDiv(s.DROPDOWN_CONTAINER);e.containerClass&&i.addClass(e.containerClass);let a=i.createEl("button",{cls:`${s.DROPDOWN_TRIGGER} clickable-icon`}),r=new DOMParser().parseFromString(e.icon,"image/svg+xml").documentElement;a.appendChild(r);let h=i.createDiv(s.DROPDOWN_MENU);return e.options.forEach(p=>{let T=h.createEl("div",{cls:`${s.DROPDOWN_ITEM} ${p.isActive?s.DROPDOWN_ITEM_ACTIVE:""}`,text:p.label});T.addEventListener("click",()=>{e.onItemClick(p.value),h.classList.remove(s.DROPDOWN_VISIBLE),h.querySelectorAll(`.${s.DROPDOWN_ITEM}`).forEach(x=>x.classList.remove(s.DROPDOWN_ITEM_ACTIVE)),T.classList.add(s.DROPDOWN_ITEM_ACTIVE)})}),a.addEventListener("click",p=>{p.stopPropagation(),this.closeAllDropdowns(),h.classList.toggle(s.DROPDOWN_VISIBLE),h.classList.contains(s.DROPDOWN_VISIBLE)?this.openDropdowns.add(i):this.openDropdowns.delete(i)}),i}createSortDropdown(t,e,i){let a=[{value:d.NAME,label:M[d.NAME],isActive:e===d.NAME},{value:d.DATE,label:M[d.DATE],isActive:e===d.DATE},{value:d.CREATED,label:M[d.CREATED],isActive:e===d.CREATED}];return this.createDropdown(t,{icon:f.SORT,options:a,onItemClick:n=>i(n),containerClass:s.SORT_CONTROLS})}createFilterDropdown(t,e,i){let a=[{value:c.ONE_TAG,label:O[c.ONE_TAG],isActive:e===c.ONE_TAG},{value:c.TWO_TAGS,label:O[c.TWO_TAGS],isActive:e===c.TWO_TAGS},{value:c.THREE_TAGS,label:O[c.THREE_TAGS],isActive:e===c.THREE_TAGS}];return this.createDropdown(t,{icon:f.FILTER,options:a,onItemClick:n=>i(n),containerClass:s.FILTER_CONTROLS})}createHeader(t){return t.createDiv(s.HEADER)}createActionButtonsContainer(t){return t.createDiv(s.ACTION_BUTTONS)}createTagsToggleButton(t,e,i){let a=t.createEl("button",{cls:`${s.DROPDOWN_TRIGGER} ${s.TAGS_TOGGLE_CONTROLS} clickable-icon ${e?s.DROPDOWN_ITEM_ACTIVE:""}`,title:e?"Hide matched tags":"Show matched tags"}),r=new DOMParser().parseFromString(f.TAGS_TOGGLE,"image/svg+xml").documentElement;return a.appendChild(r),a.addEventListener("click",h=>{h.stopPropagation(),this.closeAllDropdowns();let p=!e;i(p),p?(a.addClass(s.DROPDOWN_ITEM_ACTIVE),a.title="Hide matched tags"):(a.removeClass(s.DROPDOWN_ITEM_ACTIVE),a.title="Show matched tags")}),a}cleanup(){document.removeEventListener("click",this.handleGlobalClick),this.openDropdowns.clear()}};var g="related-notes-view",L=class extends A.ItemView{async handleSortChange(t){this.plugin.settings.defaultSortMode=t,await this.plugin.saveSettings(),this.updateView()}async handleFilterChange(t){this.plugin.settings.defaultFilterMode=t,await this.plugin.saveSettings(),this.updateView()}async handleTagsToggle(t){this.plugin.settings.showMatchedTags=t,await this.plugin.saveSettings(),this.updateView()}constructor(t,e){super(t),this.plugin=e,this.tagAnalyzer=new m(this.app),this.previewManager=new S(this.app),this.uiRenderer=new R}getViewType(){return g}getDisplayText(){return"Related notes by tag"}getIcon(){return"tag"}async onOpen(){this.container=this.contentEl,this.container.empty(),this.container.addClass(s.CONTAINER),this.updateView()}async onClose(){this.previewManager.cleanup(),this.uiRenderer.cleanup(),this.container.empty()}async updateView(){if(!this.plugin.app.workspace.layoutReady)return;this.container.empty(),this.container.addClass(s.CONTAINER);let t=this.renderHeader();this.renderControls(t);let e=this.getActiveFile();if(!e)return;let i=this.tagAnalyzer.analyzeRelatedNotes(e,this.plugin.settings);if(i.currentNoteTags.length===0){this.container.createEl("p",{text:"Active note has no tags."});return}if(i.relatedNotesMap.size===0){this.container.createEl("p",{text:"No other notes found with matching tags."});return}this.renderTagGroups(i.relatedNotesMap)}renderHeader(){return this.uiRenderer.createHeader(this.container)}renderControls(t){let e=this.uiRenderer.createActionButtonsContainer(t);this.uiRenderer.createSortDropdown(e,this.plugin.settings.defaultSortMode,i=>this.handleSortChange(i)),this.uiRenderer.createFilterDropdown(e,this.plugin.settings.defaultFilterMode,i=>this.handleFilterChange(i)),this.uiRenderer.createTagsToggleButton(e,this.plugin.settings.showMatchedTags,i=>this.handleTagsToggle(i))}getActiveFile(){let t=this.app.workspace.getActiveFile();return!t||!(t instanceof A.TFile)?(this.container.createEl("p",{text:"No active note or not a markdown file."}),null):t}renderTagGroups(t){t.forEach((e,i)=>{let a=this.container.createDiv({cls:`${s.TAG_GROUP} ${this.plugin.settings.defaultGroupState}`}),n=a.createEl("div",{text:`Notes with tag: ${i}`,cls:s.TAG_GROUP_HEADER}),o=a.createEl("ul",{cls:s.NOTES_LIST});this.setupTagGroupToggle(a,n);let r=this.tagAnalyzer.sortFiles(e,this.plugin.settings.defaultSortMode);this.renderFileList(o,r),a.createEl("hr",{cls:s.SEPARATOR})})}setupTagGroupToggle(t,e){e.addEventListener("click",()=>{t.toggleClass("collapsed",!t.hasClass("collapsed"))})}renderFileList(t,e){e.forEach(i=>{let a=t.createEl("li",{cls:s.LIST_ITEM}),n=this.createFileLink(a,i.file);this.setupFileLinkEvents(n,i.file),this.plugin.settings.showMatchedTags&&this.renderMatchedTags(a,i.matchedTags)})}createFileLink(t,e){let i=t.createEl("a",{text:e.basename,href:"#",title:`Hold Cmd/Ctrl + hover to preview
Click to open`,cls:s.NOTE_LINK});return i.dataset.filePath=e.path,i}setupFileLinkEvents(t,e){let i;t.addEventListener("mouseenter",a=>{a.metaKey||a.ctrlKey?this.previewManager.showPreview(e,t):i=setTimeout(()=>{t.matches(":hover")&&this.previewManager.getIsModifierHeld()&&this.previewManager.showPreview(e,t)},100)}),t.addEventListener("mouseleave",()=>{i&&clearTimeout(i),this.previewManager.getIsModifierHeld()||this.previewManager.hidePreview()}),t.addEventListener("click",a=>{a.preventDefault(),a.ctrlKey||a.metaKey?this.app.workspace.getLeaf("tab").openFile(e,{active:!0}):this.app.workspace.getLeaf().openFile(e,{active:!0})})}renderMatchedTags(t,e){let i=t.createDiv(s.MATCHED_TAGS);e.forEach(a=>{i.createSpan({text:a,cls:s.MATCHED_TAG})})}};var N=class extends P.Plugin{async onload(){await this.loadSettings(),this.registerView(g,t=>new L(t,this)),this.addCommand({id:"open-related-notes-panel",name:"Open sidebar",callback:()=>{this.activateView()}}),this.addSettingTab(new w(this.app,this)),this.registerEvent(this.app.workspace.on("active-leaf-change",t=>{let e=this.getView();e&&t&&e.leaf!==t&&t.view.getViewType()==="markdown"&&setTimeout(async()=>{let i=this.getView();i&&await i.updateView()},D.VIEW_UPDATE_DELAY)})),this.registerEvent(this.app.metadataCache.on("changed",async t=>{var i;let e=this.getView();e&&((i=this.app.workspace.getActiveFile())==null?void 0:i.path)===t.path&&await e.updateView()})),this.app.workspace.onLayoutReady(()=>{this.initializePanelInSidebar()})}onunload(){}getView(){let t=this.app.workspace.getLeavesOfType(g);return t.length>0?t[0].view:null}async loadSettings(){this.settings=Object.assign({},I,await this.loadData())}async saveSettings(){await this.saveData(this.settings);let t=this.getView();t&&await t.updateView()}async initializePanelInSidebar(){if(this.app.workspace.getLeavesOfType(g).length>0)return;let e=this.app.workspace.getRightLeaf(!1);e&&await e.setViewState({type:g,active:!1})}async activateView(){let t=this.app.workspace.getLeavesOfType(g);if(t.length>0){this.app.workspace.revealLeaf(t[0]);return}let e=this.app.workspace.getRightLeaf(!1);e||(e=this.app.workspace.getRightLeaf(!0)),e?(await e.setViewState({type:g,active:!0}),this.app.workspace.revealLeaf(e)):new P.Notice("Could not Open Related Notes by Tag sidebar: No available leaf.")}};
